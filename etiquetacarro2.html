<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etiqueta Pallets - Dinámica</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @page {
            size: A4;
            margin: 0;
        }
        * {
            box-sizing: border-box;
            -webkit-print-color-adjust: exact;
        }
        html, body {
            margin: 0;
            padding: 0;
            width: 210mm;
            height: 296mm; /* Ajuste fino para evitar salto de hoja */
            font-family: 'Arial Black', Gadget, sans-serif;
            background-color: white;
            overflow: hidden;
        }
        body {
            display: flex;
            flex-direction: column;
        }

        /* 1. ZONA PRODUCTO: GIGANTE */
        .zona-producto {
            height: 40%; /* 40% de la hoja */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px;
            border-bottom: 4px solid black;
        }
        #producto {
            font-size: 130pt; /* Aumentado por falta de borde */
            line-height: 0.8;
            text-transform: uppercase;
            word-wrap: break-word;
        }

        /* 2. ZONA LOTE Y FECHAS: Importante pero compacta */
        .zona-intermedia {
            height: 25%;
            display: flex;
            flex-direction: row;
            border-bottom: 4px solid black;
        }
        
        /* LOTE a la izquierda, bien grande */
        .bloque-lote {
            width: 60%;
            border-right: 4px solid black;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .etiqueta-flotante {
            background-color: black;
            color: white;
            font-size: 16pt;
            padding: 2px 15px;
            position: absolute;
            top: 0;
            left: 0;
        }
        #lote {
            font-size: 90pt;
            margin-top: 20px;
        }

        /* Fechas a la derecha, apiladas */
        .bloque-fechas {
            width: 40%;
            display: flex;
            flex-direction: column;
        }
        .dato-fecha {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-bottom: 2px solid black;
        }
        .dato-fecha:last-child { border-bottom: none; }
        
        .titulo-fecha { font-size: 10pt; font-family: Arial, sans-serif; color: #333; }
        .valor-fecha { font-size: 22pt; font-weight: bold; }

        /* 3. ZONA INFERIOR: Dinámica + QR */
        .zona-inferior {
            height: 35%;
            display: flex;
            flex-direction: row;
        }

        /* Aquí va la magia dinámica */
        #contenedor-cantidades {
            width: 60%; /* Espacio para datos */
            display: flex;
            flex-direction: column; /* Apilados verticalmente */
            border-right: 4px solid black;
        }
        
        .item-cantidad {
            flex: 1; /* Se estira para ocupar todo el alto disponible */
            display: flex;
            flex-direction: row; /* Etiqueta izq, numero der */
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            border-bottom: 2px solid black;
        }
        .item-cantidad:last-child { border-bottom: none; }

        .cant-label { font-size: 20pt; font-family: Arial, sans-serif; text-align: left;}
        .cant-valor { font-size: 55pt; font-weight: bold; text-align: right;}

        /* QR y Footer */
        .zona-qr {
            width: 40%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        #codigo_unico { font-size: 12pt; font-family: Arial; margin-bottom: 5px; }

    </style>
</head>
<body>

    <div class="zona-producto">
        <div id="producto">PRODUCTO</div>
    </div>

    <div class="zona-intermedia">
        <div class="bloque-lote">
            <div class="etiqueta-flotante">LOTE</div>
            <div id="lote">---</div>
        </div>
        <div class="bloque-fechas">
            <div class="dato-fecha">
                <span class="titulo-fecha">VENCIMIENTO</span>
                <span class="valor-fecha" id="fecha_vencimiento">--/--/--</span>
            </div>
            <div class="dato-fecha">
                <span class="titulo-fecha">ELABORACIÓN</span>
                <span class="valor-fecha" id="fecha">--/--/--</span>
            </div>
        </div>
    </div>

    <div class="zona-inferior">
        <div id="contenedor-cantidades"></div>

        <div class="zona-qr">
            <div id="codigo_unico"></div>
            <div id="qrcode"></div>
        </div>
    </div>

    <script>
        // --- Funciones Utiles ---
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        function convertirFecha(f) {
            if (!f) return '';
            const match = f.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
            if (match) return `${match[2]}/${match[1]}/${match[3]}`; // Mes/Dia fix si viene invertido, ajustar segun necesidad real
            return f; 
        }

        // --- Lectura de Datos ---
        // Asumimos que si no viene parametro es 0
        const rawPallet = getUrlParameter('pallet');
        const rawCajones = getUrlParameter('cantidad_cajones');
        const rawCajas = getUrlParameter('cantidad_cajas');
        const rawUnidades = getUrlParameter('unidades');

        const datos = {
            producto: getUrlParameter('producto').toUpperCase() || 'SIN NOMBRE',
            lote: getUrlParameter('lote').toUpperCase() || '---',
            fechaVenc: getUrlParameter('fecha_vencimiento') || '',
            fechaElab: getUrlParameter('fecha') || '',
            id: getUrlParameter('uniqueid') || '',
            // Convertimos a numero para verificar si son > 0
            cantidades: [
                { label: 'PALLETS', val: rawPallet, num: Number(rawPallet) },
                { label: 'CAJONES', val: rawCajones, num: Number(rawCajones) },
                { label: 'CAJAS', val: rawCajas, num: Number(rawCajas) },
                { label: 'UNID. ADIC.', val: rawUnidades, num: Number(rawUnidades) }
            ],
            // Datos extra para el QR string
            codProd: getUrlParameter('codigo_producto'),
            cantUn: getUrlParameter('cantidad_un')
        };

        // --- Renderizado Estático ---
        document.getElementById('producto').innerText = datos.producto;
        document.getElementById('lote').innerText = datos.lote;
        document.getElementById('fecha_vencimiento').innerText = datos.fechaVenc;
        document.getElementById('fecha').innerText = datos.fechaElab;
        document.getElementById('codigo_unico').innerText = "ID: " + datos.id;

        // --- Renderizado Dinámico de Cantidades ---
        const container = document.getElementById('contenedor-cantidades');
        let camposActivos = 0;

        datos.cantidades.forEach(item => {
            // Solo mostramos si es un numero valido y mayor a 0
            if (item.num && item.num > 0) {
                camposActivos++;
                const div = document.createElement('div');
                div.className = 'item-cantidad';
                div.innerHTML = `
                    <span class="cant-label">${item.label}</span>
                    <span class="cant-valor">${item.val}</span>
                `;
                container.appendChild(div);
            }
        });

        // Si por casualidad todo es 0, mostramos algo para que no quede hueco
        if (camposActivos === 0) {
            container.innerHTML = `<div class="item-cantidad" style="justify-content:center"><span class="cant-label">SIN CANTIDADES</span></div>`;
        }

        // --- Generación QR ---
        const qrString = `ID=${datos.id}|F=${datos.fechaElab}|P=${datos.producto}|L=${datos.lote}|V=${datos.fechaVenc}|T=${datos.cantidades[0].val}|J=${datos.cantidades[1].val}|X=${datos.cantidades[2].val}|A=${datos.cantidades[3].val}`;

        window.onload = function() {
            new QRCode(document.getElementById("qrcode"), {
                text: qrString,
                width: 250,
                height: 250,
                correctLevel: QRCode.CorrectLevel.L
            });

            setTimeout(() => { window.print(); }, 800);
        };

        window.onafterprint = function () {
            document.body.innerHTML = `<div style="text-align:center; padding-top:50px; font-family:sans-serif;"><h1>✅ Fin</h1></div>`;
        };

    </script>
</body>
</html>
