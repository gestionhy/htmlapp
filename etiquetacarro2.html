<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Etiqueta Landscape - Don Yeyo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @page { 
            size: A4 landscape; 
            margin: 0; 
        }
        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Arial Black', 'Arial', sans-serif; 
            margin: 0; 
            padding: 5mm; 
            width: 297mm; /* Ancho A4 Horizontal */
            height: 210mm; /* Alto A4 Horizontal */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: white;
        }

        /* --- ZONA 1: PRODUCTO (Arriba, todo el ancho) --- */
        .zona-superior {
            height: 40%; /* 40% de la altura para el nombre */
            width: 100%;
            border-bottom: 5px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            overflow: hidden;
        }
        #producto {
            font-size: 110pt; /* Gigante */
            line-height: 0.9;
            text-transform: uppercase;
            white-space: nowrap; /* Intenta mantener una linea */
        }

        /* --- ZONA 2: DATOS (Abajo, dividido en 3 columnas) --- */
        .zona-inferior {
            height: 60%;
            display: flex;
            flex-direction: row;
        }

        /* COLUMNA 1: LOTE Y FECHAS (35%) */
        .col-izq {
            width: 35%;
            border-right: 5px solid black;
            display: flex;
            flex-direction: column;
        }
        .box-lote {
            flex: 1;
            border-bottom: 3px solid black;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .etiqueta-flotante {
            position: absolute; top: 0; left: 0;
            background: black; color: white;
            font-size: 14pt; padding: 2px 8px;
        }
        #lote { font-size: 55pt; font-weight: bold; }

        .box-fechas {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 10px;
        }
        .fila-fecha { margin-bottom: 10px; text-align: center; }
        .titulo-fecha { font-size: 10pt; font-family: Arial; display: block;}
        .valor-fecha { font-size: 18pt; font-weight: bold; }

        /* COLUMNA 2: CANTIDADES (35%) */
        .col-cen {
            width: 35%;
            border-right: 5px solid black;
            display: flex;
            flex-direction: column;
        }
        .item-dato {
            flex: 1;
            border-bottom: 2px solid black;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
        }
        .item-dato:last-child { border-bottom: none; }
        .label-dato { font-size: 16pt; font-family: Arial; }
        .valor-dato { font-size: 40pt; font-weight: bold; }
        
        /* Resaltar Total Unidades */
        .item-total { background-color: #e0e0e0; border-bottom: 4px solid black !important; }

        /* COLUMNA 3: QR (30%) */
        .col-der {
            width: 30%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        #id-unico { font-size: 12pt; font-weight: bold; font-family: Arial; margin-bottom: 5px; }

    </style>
</head>
<body>

    <div class="zona-superior">
        <div id="producto">PRODUCTO</div>
    </div>

    <div class="zona-inferior">
        
        <div class="col-izq">
            <div class="box-lote">
                <span class="etiqueta-flotante">LOTE</span>
                <div id="lote">---</div>
            </div>
            <div class="box-fechas">
                <div class="fila-fecha">
                    <span class="titulo-fecha">VENCIMIENTO</span>
                    <span class="valor-fecha" id="vencimiento">--/--/--</span>
                </div>
                <div class="fila-fecha">
                    <span class="titulo-fecha">ELABORACIÓN</span>
                    <span class="valor-fecha" id="elaboracion">--/--/--</span>
                </div>
            </div>
        </div>

        <div class="col-cen" id="contenedor-cantidades">
            </div>

        <div class="col-der">
            <div id="id-unico">ID: 0000</div>
            <div id="qrcode"></div>
        </div>

    </div>

    <script>
        function getParam(name) {
            const results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(window.location.href);
            return results ? decodeURIComponent(results[1].replace(/\+/g, ' ')) : '';
        }

        // --- FUNCIÓN PARA CORREGIR FECHAS (MM/DD -> DD/MM) ---
        function formatFechaArg(fechaStr) {
            if (!fechaStr) return '';
            
            // Separar fecha de hora si existe
            let [soloFecha, hora] = fechaStr.split(' ');
            
            // Asumimos que AppSheet a veces manda MM/DD/YYYY (ej: 03/13/2026)
            // Si detectamos '/' intentamos parsear
            if (soloFecha.includes('/')) {
                const partes = soloFecha.split('/');
                if (partes.length === 3) {
                    // Si el primer numero es > 12, asumimos que YA es DD/MM, si no, asumimos MM/DD 
                    // (Esta lógica es riesgosa si es 01/02, pero AppSheet suele ser consistente con US format)
                    // Para ir a lo seguro con tu ejemplo (03/13), invertimos los dos primeros.
                    // Entrada: MM/DD/YYYY -> Salida: DD/MM/YYYY
                    const mes = partes[0];
                    const dia = partes[1];
                    const anio = partes[2];
                    
                    // Reconstruimos a DD/MM/YYYY
                    soloFecha = `${dia}/${mes}/${anio}`;
                }
            }
            
            // Si había hora, recortarla a HH:MM (sin segundos) y agregarla
            if (hora) {
                const horaCorta = hora.substring(0, 5);
                return `${soloFecha} ${horaCorta}`;
            }
            return soloFecha;
        }

        const d = {
            prod: getParam('producto') || 'HAMBURGUESA',
            lote: getParam('lote') || '---',
            venc: formatFechaArg(getParam('fecha_vencimiento')), // Aplicamos formato
            elab: formatFechaArg(getParam('fecha')),             // Aplicamos formato con hora
            id: getParam('uniqueid') || '',
            total: getParam('cantidad_un') || '0',
            cajones: getParam('cantidad_cajones'),
            unidades: getParam('unidades'),
            pallets: getParam('pallet'),
            cajas: getParam('cantidad_cajas')
        };

        // Render Fijos
        document.getElementById('producto').innerText = d.prod;
        document.getElementById('lote').innerText = d.lote;
        document.getElementById('vencimiento').innerText = d.venc;
        document.getElementById('elaboracion').innerText = d.elab;
        document.getElementById('id-unico').innerText = "ID: " + d.id;

        // Render Dinámico Cantidades
        const cont = document.getElementById('contenedor-cantidades');
        const lista = [
            { l: 'TOTAL UNIDADES', v: d.total, fijo: true },
            { l: 'CAJONES', v: d.cajones },
            { l: 'CAJAS', v: d.cajas },
            { l: 'UNID. SUELTAS', v: d.unidades },
            { l: 'PALLETS', v: d.pallets }
        ];

        lista.forEach(item => {
            const valNum = parseInt(item.v);
            if(item.fijo || (item.v && valNum > 0)){
                const div = document.createElement('div');
                div.className = 'item-dato';
                if(item.fijo) div.classList.add('item-total');
                const valorMostrar = item.v ? item.v : '0';
                div.innerHTML = `<span class="label-dato">${item.l}</span><span class="valor-dato">${valorMostrar}</span>`;
                cont.appendChild(div);
            }
        });

        // QR
        const qrString = `ID:${d.id}|P:${d.prod}|L:${d.lote}|TOT:${d.total}`;
        new QRCode(document.getElementById("qrcode"), {
            text: qrString,
            width: 260,
            height: 260,
            correctLevel: QRCode.CorrectLevel.L
        });

        window.onload = () => { setTimeout(() => { window.print(); }, 800); };
    </script>
</body>
</html>
