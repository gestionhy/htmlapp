<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Etiqueta Fija Multi-linea - Don Yeyo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @page { 
            size: A4 landscape; 
            margin: 0; 
        }
        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Arial Black', 'Arial', sans-serif; 
            margin: 0; 
            padding: 5mm; 
            width: 297mm; 
            height: 210mm; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: white;
        }

        /* --- ZONA 1: PRODUCTO (42% de la altura) --- */
        .zona-superior {
            height: 50%; 
            width: 100%;
            border-bottom: 5px solid black;
            display: flex;
            align-items: center;     
            justify-content: center; 
            overflow: hidden; 
            text-align: center;
            padding: 5px;
        }
        
        #producto {
            /* TAMAÑO FIJO Y GRANDE */
            font-size: 105pt; 
            line-height: 0.9; /* Interlineado ajustado para que entren 2 lineas */
            text-transform: uppercase;
            /* Permite saltar de linea */
            white-space: normal; 
            word-wrap: break-word; 
        }

        /* --- ZONA 2: DATOS (58% de la altura) --- */
        .zona-inferior {
            height: 50%;
            display: flex;
            flex-direction: row;
        }

        /* COLUMNA 1: LOTE Y FECHAS (35%) */
        .col-izq {
            width: 35%;
            border-right: 5px solid black;
            display: flex;
            flex-direction: column;
        }
        
        .box-lote {
            height: 45%; /* Un poco menos de altura para dar lugar a fechas */
            border-bottom: 3px solid black;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .etiqueta-flotante {
            position: absolute; top: 0; left: 0;
            background: black; color: white;
            font-family: Arial; font-weight: bold;
            font-size: 12pt; padding: 2px 8px;
        }
        #lote { font-size: 60pt; font-weight: bold; }

        .box-fechas {
            height: 55%;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            padding: 5px;
        }
        .fila-fecha { text-align: center; }
        .titulo-fecha { font-size: 15pt; font-family: Arial; display: block; color: #333;}
        .valor-fecha { font-size: 36pt; font-weight: bold; display: block; line-height: 1.1;}

        /* COLUMNA 2: CANTIDADES (35%) */
        .col-cen {
            width: 25%;
            border-right: 5px solid black;
            display: flex;
            flex-direction: column;
        }
        .item-dato {
            border-bottom: 2px solid black;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            flex-grow: 1; /* Se estira para ocupar espacio */
        }
        .item-dato:last-child { border-bottom: none; }
        
        .label-dato { font-size: 16pt; font-family: Arial; }
        .valor-dato { font-size: 40pt; font-weight: bold; }
        
        /* Resaltado */
        .item-total { background-color: #eee; border-bottom: 4px solid black !important; }

        /* COLUMNA 3: QR (30%) */
        .col-der {
            width: 40%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        #id-unico { font-size: 12pt; font-weight: bold; font-family: Arial; margin-bottom: 10px; }

    </style>
</head>
<body>

    <div class="zona-superior">
        <div id="producto">PRODUCTO</div>
    </div>

    <div class="zona-inferior">
        
        <div class="col-izq">
            <div class="box-lote">
                <span class="etiqueta-flotante">LOTE</span>
                <div id="lote">---</div>
            </div>
            <div class="box-fechas">
                <div class="fila-fecha">
                    <span class="titulo-fecha">VENCIMIENTO</span>
                    <span class="valor-fecha" id="vencimiento">--/--/--</span>
                </div>
                <div class="fila-fecha">
                    <span class="titulo-fecha">ELABORACIÓN</span>
                    <span class="valor-fecha" id="elaboracion">--/--/--</span>
                </div>
            </div>
        </div>

        <div class="col-cen" id="contenedor-cantidades"></div>

        <div class="col-der">
            <div id="id-unico">ID: 0000</div>
            <div id="qrcode"></div>
        </div>

    </div>

    <script>
        function getParam(name) {
            const results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(window.location.href);
            return results ? decodeURIComponent(results[1].replace(/\+/g, ' ')) : '';
        }

        // --- FORMATO FECHA: MM/DD/YYYY -> DD/MM/YYYY ---
        function formatFechaArg(fechaStr) {
            if (!fechaStr) return '';
            let [soloFecha, hora] = fechaStr.split(' ');
            
            // Si viene con barras, intentamos arreglar el orden
            if (soloFecha.includes('/')) {
                const partes = soloFecha.split('/');
                if (partes.length === 3) {
                    // Asumimos entrada MM/DD/YYYY, salimos con DD/MM/YYYY
                    const m = partes[0]; const d = partes[1]; const y = partes[2];
                    
                    // Pequeña validación: si el primer numero es > 12, ya viene bien (DD/MM)
                    // Si no, lo damos vuelta.
                    if(parseInt(m) > 12) {
                        soloFecha = `${m}/${d}`; // Ya estaba bien
                    } else {
                        soloFecha = `${d}/${m}`; // Lo invertimos
                    }
                }
            }
            
            // Limpiar segundos de la hora
            if (hora) {
                return `${soloFecha} ${hora.substring(0, 5)}`;
            }
            return soloFecha;
        }

        const d = {
            prod: getParam('producto') || 'HAMBURGUESA DOBLE', // Ejemplo largo
            lote: getParam('lote') || '---',
            venc: formatFechaArg(getParam('fecha_vencimiento')), 
            elab: formatFechaArg(getParam('fecha')),             
            id: getParam('uniqueid') || '',
            total: getParam('cantidad_un') || '0',
            cajones: getParam('cantidad_cajones'),
            unidades: getParam('unidades'),
            pallets: getParam('pallet'),
            cajas: getParam('cantidad_cajas')
        };

        // Render Fijos
        document.getElementById('producto').innerText = d.prod;
        document.getElementById('lote').innerText = d.lote;
        document.getElementById('vencimiento').innerText = d.venc;
        document.getElementById('elaboracion').innerText = d.elab;
        document.getElementById('id-unico').innerText = "ID: " + d.id;

        // Render Dinámico Cantidades
        const cont = document.getElementById('contenedor-cantidades');
        const lista = [
            { l: 'TOTAL UNIDADES', v: d.total, fijo: true },
            { l: 'CAJONES', v: d.cajones },
            { l: 'CAJAS', v: d.cajas },
            { l: 'UNID. SUELTAS', v: d.unidades },
            { l: 'PALLETS', v: d.pallets }
        ];

        lista.forEach(item => {
            const valNum = parseInt(item.v);
            if(item.fijo || (item.v && valNum > 0)){
                const div = document.createElement('div');
                div.className = 'item-dato';
                if(item.fijo) div.classList.add('item-total');
                const valorMostrar = item.v ? item.v : '0';
                div.innerHTML = `<span class="label-dato">${item.l}</span><span class="valor-dato">${valorMostrar}</span>`;
                cont.appendChild(div);
            }
        });

        // QR
        const qrString = `ID:${d.id}|P:${d.prod}|L:${d.lote}|TOT:${d.total}`;
        new QRCode(document.getElementById("qrcode"), {
            text: qrString,
            width: 300,
            height: 300,
            correctLevel: QRCode.CorrectLevel.L
        });

        window.onload = () => { setTimeout(() => { window.print(); }, 800); };
    </script>
</body>
</html>
