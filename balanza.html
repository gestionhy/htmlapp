<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Historial de Calibraciones</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #f4f4f4;
    }
    .card {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      max-width: 98%;
      margin: auto;
      overflow-x: auto;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header img {
      height: 60px;
    }
    h1 {
      color: #800020;
    }
    .next-date {
      font-size: 16px;
      margin-top: 10px;
      font-weight: bold;
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background: #800020;
      color: white;
    }
    .error {
      color: red;
      font-weight: bold;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <img src="https://drive.google.com/uc?id=1jgxshv3Edd8LIFtM5eJwdn5dX7ZZrT5G" alt="Don Yeyo Logo">
      <h1>Historial de calibraci√≥n - Balanza <span id="balanza"></span></h1>
    </div>

    <div id="mensaje" class="error"></div>
    <div class="next-date" id="proxima"></div>

    <table id="tabla" style="display:none">
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script>
    const balanzaId = new URLSearchParams(window.location.search).get("balanza");
    document.getElementById("balanza").innerText = balanzaId || "(no especificada)";

    if (!balanzaId) {
      document.getElementById("mensaje").innerText = "‚ùå No se especific√≥ el par√°metro 'balanza' en la URL.";
    } else {
      const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQX2-1Ar_AxL1GqFWGKH5AlXyJrhvbDQ5GlkoyQx5jfIS2Z-uzht_s31a-_bToONPqZTTYvfbrQw3JH/pub?gid=855857351&single=true&output=csv";

      fetch(csvURL)
        .then(res => res.text())
        .then(csv => {
          const filas = csv.split("\n").map(l => l.split(","));
          const headers = filas[0].map(h => h.trim());
          const balanzaColIndex = headers.findIndex(h => h.includes("N¬∫ Balanza") || h.includes("CODIGO"));

          if (balanzaColIndex === -1) {
            document.getElementById("mensaje").innerText = "‚ùå No se encontr√≥ la columna de N¬∫ de Balanza.";
            return;
          }

          const registros = filas.slice(1).filter(row => row[balanzaColIndex]?.trim() === balanzaId);

          if (registros.length === 0) {
            document.getElementById("mensaje").innerText = "‚ö†Ô∏è No se encontraron registros para esta balanza.";
            return;
          }

          const fechaIndex = headers.findIndex(h => h.toLowerCase() === "fecha");

          // Ordenar ASCENDENTE (de m√°s vieja a m√°s nueva)
          registros.sort((a, b) => new Date(a[fechaIndex]) - new Date(b[fechaIndex]));

          // Calcular pr√≥xima fecha de calibraci√≥n (√∫ltima + 60 d√≠as)
          const ultimaFechaStr = registros[registros.length - 1][fechaIndex];
          const ultimaFecha = new Date(ultimaFechaStr);
          if (!isNaN(ultimaFecha)) {
            const proxima = new Date(ultimaFecha);
            proxima.setDate(proxima.getDate() + 60);
            document.getElementById("proxima").textContent = `üìÖ Fecha de pr√≥xima calibraci√≥n sugerida: ${proxima.toLocaleDateString('es-AR')}`;
          }

          // Mostrar hasta 5 registros
          const tabla = document.getElementById("tabla");
          const thead = document.getElementById("thead");
          const tbody = document.getElementById("tbody");

          thead.innerHTML = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";

          registros.slice(-5).forEach(row => {
            const tr = document.createElement("tr");
            row.forEach((cell, i) => {
              const td = document.createElement("td");
              td.textContent = cell || "-";
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });

          tabla.style.display = "table";
        })
        .catch(err => {
          document.getElementById("mensaje").textContent = "‚ùå Error al cargar los datos.";
        });
    }
  </script>
</body>
</html>
